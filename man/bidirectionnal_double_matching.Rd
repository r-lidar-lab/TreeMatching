% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/matching_functions.R
\name{bidirectionnal_double_matching}
\alias{bidirectionnal_double_matching}
\title{Match Trees Between Measured and Inventory Maps Using 3D 2-Nearest Neighbors}
\usage{
bidirectionnal_double_matching(treemap, dmax = 2, dz = 0.1)
}
\arguments{
\item{treemap}{A `TreeMapMatching` object created with [make_mapmatching()], containing the `inventory`,
`measured`, `center`, and `radius`.}

\item{dmax}{Maximum allowed horizontal (XY) distance for matching. Default is 2.}

\item{dz}{Maximum allowed vertical (Z/DBH) difference. Default is 0.1.}
}
\value{
A `data.table` with two columns:
\describe{
  \item{index_measure}{Index of the measured tree}
  \item{index_inventory}{Index of the matched inventory tree, or `NA` if no match was found}
}
}
\description{
This function performs a bidirectional 3D 2-nearest-neighbors matching between two sets of trees.
It is bidirectional because it performs an inventory to measure matching and a measure to
inventory matching. It used 2-nearest-neighbors instead of 1-nearest-neighbors to give a chance to
each tree to get matched twice so each tree as a fall back matching reducing probabilities of collision
and therefore ommission and commission between from trees that would be matched to the same reference
using a 1-nn approache.\cr\cr
It uses a scaled 3D distance (based on X, Y, and DBH as a proxy for Z) to identify the best match
for each tree in both directions. The final match is the most consistent and closest association
between the two sets.
}
\details{
The algorithm works in two passes:
\enumerate{
  \item From measured trees to inventory: for each measured tree, it finds its two closest neighbors
        in the inventory using 3D Euclidean distance. The third dimension (Z) is synthesized from the DBH
        (diameter at breast height), scaled to be comparable with X and Y.
  \item From inventory to measured: the same process is repeated in reverse.
}
For both passes, only matches within a maximum distance (`dmax`) in the X/Y plane and a maximum DBH
difference (`dz`) are retained. Each inventory tree can only be assigned to one measured tree
(and vice versa), to prevent duplicates.\cr\cr
If a tree has two possible matches (one in each direction), the closest in full 3D distance is chosen.
In case of ambiguous matches (i.e., multiple measured trees selecting the same inventory tree), the
one with the shortest 3D distance is kept, and the others are discarded.\cr\cr
This approach is particularly useful when traditional 2D proximity does not yield reliable matches
due to spatial shifts and inaccuracies. The use of DBH as a proxy for vertical position improves
the separation of nearby stems.
}
